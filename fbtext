#!/usr/bin/python3
# Write UTF-8 text to frame buffer, works with python 2 or 3

from __future__ import print_function
import os, sys, getopt
import fb, image

usage = """
Usage:

    fbtext [options] text.file

Write arbitrary multi-line UTF8 text to frame buffer.

Options are:

    -b width                - screen border width, default is "0" (no border)
    -c [fg][:bg]            - foreground and background colors, default is "white:black"
    -d device               - framebuffer device, default is "/dev/fb0"
    -f path/to/font         - path to font
    -g direction            - text gravity, one of "nw", "n", "ne", "w", "c", "e", "sw", "s", or "se", default is "nw"
    -m                      - text margin in pixels, default is "10"
    -s point                - font point size, default is "20"
    -w                      - wrap text at right margin
    -x                      - clip text at right/bottom margins

Font names "m" and "p" will select built-in monospaced or proportional fonts.
The default font is "m".

-w and -x should be avoided if using proportional fonts.

If the text file name is '-' then read text from stdin.
"""

__here__ = os.path.dirname(__file__) or '.'

# set defaults
bg = "black"
fg = "white"
gravity = "nw"
point = 20
font = None
device = "/dev/fb0"
margin = 10
border = 0
wrap = False
clip = False

try:

    opts, args = getopt.getopt(sys.argv[1:],"b:c:d:f:g:m:r:s:wxyz")

    for opt, arg in opts:
        if   opt == "-b": border = int(arg)
        elif opt == "-c": fg,bg = (arg.lower()+":").split(":")[:2]
        elif opt == "-d": device = arg
        elif opt == "-f": font = arg
        elif opt == "-g": gravity = arg.lower()
        elif opt == "-m": margin = int(arg)
        elif opt == "-r": pass # legacy
        elif opt == "-s": point = int(arg)
        elif opt == "-w": wrap = True
        elif opt == "-x": clip = True
        elif opt == "-y": pass # legacy
        else: raise Exception("Invalid option '%s'" % opt)

    if bg == '': bg = "black"
    if not gravity in ("nw","n","ne","w","c","e","sw","s","se"): raise Exception("Invalid gravity '%s'" % gravity)

    if not font or font[:1] == "m": font = __here__+"/WenQuanYiMicroHeiMono.ttf"
    elif font[:1] == "p": font=__here__+"/WenQuanYiMicroHei.ttf"
    if not os.path.isfile(font): raise Exception("Can't find font %s" % font)

except Exception as e:

    print (str(e),"\n",usage,file = sys.stderr)
    quit(1)

# open file or stdin
if not args or args[0] == '-':
    fh = sys.stdin.buffer
else:
    fh = open(args[0], mode='rb')
# get list of lines
text = fh.read.splitlines()
fh.close()

f = fb.framebuffer(device)
i = image.image(width=f.width, height=f.height, fg=fg, bg=bg)
if border:
    i.border(border)
    margin += border
i.text(text, left=margin, top=margin, width=i.width-(margin*2), height=i.height-(margin*2), gravity=gravity, wrap=wrap, clip=clip, point=point, font=font)
f.pack(i.rgb())
