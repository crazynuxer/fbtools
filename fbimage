#!/usr/bin/python3
# Write image to frame buffer, works with python 2 or 3

from __future__ import print_function
import sys, getopt, fb, screen
from pgmagick import *

usage="""
Usage:

    fbimage [options] image.file

Decode an image file and output to frame buffer.

Options are:

    -c color                - background color, default is "black"
    -d device               - framebuffer device, default is "/dev/fb0"
    -m width                - margin width, default is "0" (no margin)
    -o                      - overlay existing framebuffer image
    -s                      - stretch the image to fit, default is scale to fit.

If image.file is "-" then read the image from stdin.
"""

color="black"
margin=0
stretch=False
device="/dev/fb0"
overlay=False

try:

    opts, args = getopt.getopt(sys.argv[1:],"c:d:sm:o")
    for opt, arg in opts:
        if   opt == "-c": color=arg.lower()
        elif opt == "-d": device=arg
        elif opt == "-m": margin=int(arg)
        elif opt == "-s": stretch=True
        elif opt == "-o": overlay=True
        else: raise Exception("Invalid option '%s'" % opt)
    if len(args) != 1: raise Exception("Expected a file name (or '-')")
    filename = args[0]

except Exception as e:
    print (str(e), usage, file=sys.stderr)
    quit(1)

# read the image with graphicsmagick
if filename == '-':
    fh = sys.stdin.buffer
else:
    fh = open(filename, mode='rb')
image = Image(Blob(fh.read()))

# open the framebuffer
fb = fb.framebuffer(device)

# create a screen, possibly with unpacked framebuffer data
screen = screen.screen(fb.width, fb.height, bg=color, rgb=fb.unpack() if overlay else None)

# scale the image to fit withing the desired margin
g = Geometry(screen.width-(margin*2), screen.height-(margin*2))
if stretch: g.aspect(True)
image.scale(g)

# merge it onto the screen
screen.merge(image, 'center')

# update the framebuffer
fb.pack(screen.rgb())
